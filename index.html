<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (—Å–ø–∏—Å–∫–∏)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
    body { padding: 20px; background: #f9f9f9; color: #333; }
    h1 { text-align: center; margin: 10px 0; color: #2c3e50; font-size: 24px; }
    h2 { text-align: center; margin: 5px 0; font-size: 18px; color: #555; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f1f1f1; }
    select, input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="number"] { text-align: right; }
    .readonly {
      background-color: #f0f0f0;
      cursor: not-allowed;
      pointer-events: none;
      user-select: none;
    }
    .value-cell {
      background-color: #f9f9f9;
      font-weight: bold;
      pointer-events: none;
      user-select: text;
    }
    .actions button {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      background: #e74c3c;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .actions button:hover { background: #c0392b; }
    .btn-group {
      text-align: center;
      margin: 20px 0;
    }
    .btn-group button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 5px;
      background: #3498db;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-group button:hover { background: #2980b9; }
    .total-row {
      font-weight: bold;
      background: #f8f9fa;
    }
    .footer-text {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; }
      td { text-align: right; padding-left: 50%; position: relative; }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–º¬≥)</h1>
    <h2>–í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –ø–æ–∑–∏—Ü–∏–π</h2>

    <table id="costTable">
      <thead>
        <tr>
          <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          <th>–ü–æ–∑. / –æ–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–û–±—ä—ë–º (–º¬≥)</th>
          <th>–¶–µ–Ω–∞ –∑–∞ 1 –º¬≥ (—Ä—É–±.)</th>
          <th>–ï–¥. –∏–∑–º.</th>
          <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è -->
      </tbody>
      <tfoot>
        <tr class="total-row">
          <td colspan="5" style="text-align: right;">–ò–¢–û–ì–û–í–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨:</td>
          <td id="total">0.00 —Ä—É–±.</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="btn-group">
      <button onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
      <button onclick="exportToPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
      <button onclick="exportToExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX</button>
    </div>

    <div class="footer-text">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏. –¶–µ–Ω–∞ –∑–∞ –º¬≥ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å).</p>
      <p>–í—Å–µ —Ä–∞—Å—á—ë—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –≤ –∫—É–±–æ–º–µ—Ç—Ä–∞—Ö (–º¬≥).</p>
    </div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    // –î–∞–Ω–Ω—ã–µ: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí –ø–æ–∑–∏—Ü–∏–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ —Ü–µ–Ω–æ–π
    const positionOptions = {
      "–§—É–Ω–¥–∞–º–µ–Ω—Ç": [
        { desc: "–ë–µ—Ç–æ–Ω B20", price: 4800 },
        { desc: "–ë–µ—Ç–æ–Ω B25", price: 5100 },
        { desc: "–ë–µ—Ç–æ–Ω B30", price: 5400 }
      ],
      "–°—Ç–µ–Ω—ã": [
        { desc: "–ö–µ—Ä–∞–º–∑–∏—Ç–æ–±–µ—Ç–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏", price: 2900 },
        { desc: "–ì–∞–∑–æ–±–µ—Ç–æ–Ω D500", price: 3200 }
      ],
      "–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏—è": [
        { desc: "–ú–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ", price: 6800 },
        { desc: "–ñ/–± –ø–ª–∏—Ç—ã", price: 5900 }
      ],
      "–°—Ç—è–∂–∫–∞": [
        { desc: "–¶–µ–º–µ–Ω—Ç–Ω–æ-–ø–µ—Å—á–∞–Ω–∞—è —Å—Ç—è–∂–∫–∞", price: 2900 }
      ]
    };

    const categories = Object.keys(positionOptions);

    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('kalkulatorData');
      if (saved) {
        const data = JSON.parse(saved);
        data.forEach(item => addRow(item));
      } else {
        // –ü—Ä–∏–º–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        addRow({ category: "–§—É–Ω–¥–∞–º–µ–Ω—Ç", description: "–ë–µ—Ç–æ–Ω B25", qty: "50", price: "5100" });
      }
      recalc();
    });

    function createCategorySelect(selected = '') {
      let html = `<select ${selected ? '' : 'disabled'}>`;
      html += '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      categories.forEach(cat => {
        html += `<option value="${cat}" ${cat === selected ? 'selected' : ''}>${cat}</option>`;
      });
      html += '</select>';
      return html;
    }

    function createPositionSelect(category, selectedDesc = '') {
      if (!category || !positionOptions[category]) {
        return '<select disabled><option>‚Äî –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî</option></select>';
      }
      let html = '<select>';
      positionOptions[category].forEach(opt => {
        html += `<option value="${opt.desc}" data-price="${opt.price}" ${opt.desc === selectedDesc ? 'selected' : ''}>${opt.desc}</option>`;
      });
      html += '</select>';
      return html;
    }

    function addRow(data = null) {
      const tbody = document.getElementById('tableBody');
      const row = tbody.insertRow();
      const category = data?.category || '';
      const description = data?.description || '';
      const qty = data?.qty || '';
      const price = data?.price || (description && category ? (positionOptions[category]?.find(p => p.desc === description)?.price || '') : '');

      row.innerHTML = `
        <td data-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">${createCategorySelect(category)}</td>
        <td data-label="–ü–æ–∑–∏—Ü–∏—è">${createPositionSelect(category, description)}</td>
        <td data-label="–û–±—ä—ë–º"><input type="number" min="0" step="0.01" value="${qty}" oninput="recalc()"></td>
        <td data-label="–¶–µ–Ω–∞"><input type="number" min="0" step="0.01" value="${price}" oninput="recalc()"></td>
        <td data-label="–ï–¥. –∏–∑–º." class="readonly">–º¬≥</td>
        <td data-label="–°—Ç–æ–∏–º–æ—Å—Ç—å" class="value-cell">0.00</td>
        <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="actions"><button onclick="removeRow(this)">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;

      // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏
      const catSelect = row.cells[0].querySelector('select');
      const posSelect = row.cells[1].querySelector('select');

      if (catSelect) {
        catSelect.onchange = () => {
          const newCat = catSelect.value;
          row.cells[1].innerHTML = createPositionSelect(newCat);
          const newSelect = row.cells[1].querySelector('select');
          if (newSelect) {
            newSelect.onchange = () => {
              const priceVal = newSelect.selectedOptions[0]?.dataset.price || '';
              row.cells[3].querySelector('input').value = priceVal;
              recalc();
              saveData();
            };
          }
          recalc();
          saveData();
        };
      }

      if (posSelect && !posSelect.disabled) {
        posSelect.onchange = () => {
          const priceVal = posSelect.selectedOptions[0]?.dataset.price || '';
          row.cells[3].querySelector('input').value = priceVal;
          recalc();
          saveData();
        };
      }

      recalc();
      saveData();
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      recalc();
      saveData();
    }

    function recalc() {
      let total = 0;
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const qty = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const price = parseFloat(row.cells[3].querySelector('input').value) || 0;
        const value = qty * price;
        row.cells[5].textContent = value.toFixed(2);
        total += value;
      });
      document.getElementById('total').textContent = total.toFixed(2) + ' —Ä—É–±.';
    }

    function saveData() {
      const rows = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const catSelect = row.cells[0].querySelector('select');
        const posSelect = row.cells[1].querySelector('select');
        const qtyInput = row.cells[2].querySelector('input');
        const priceInput = row.cells[3].querySelector('input');

        rows.push({
          category: catSelect?.value || '',
          description: posSelect?.value || '',
          qty: qtyInput?.value || '',
          price: priceInput?.value || ''
        });
      });
      localStorage.setItem('kalkulatorData', JSON.stringify(rows));
    }

    function exportToPDF() {
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–º¬≥)', 14, 20);
      const tableData = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = parseFloat(row.cells[2].querySelector('input')?.value) || '';
        const price = parseFloat(row.cells[3].querySelector('input')?.value) || '';
        const value = parseFloat(row.cells[5].textContent) || 0;
        tableData.push([cat, desc, qty, price, '–º¬≥', value]);
      });
      doc.autoTable({
        startY: 30,
        head: [['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü–æ–∑–∏—Ü–∏—è', '–û–±—ä—ë–º (–º¬≥)', '–¶–µ–Ω–∞ –∑–∞ 1 –º¬≥', '–ï–¥. –∏–∑–º.', '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219] }
      });
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(14);
      doc.text(`–ò—Ç–æ–≥–æ: ${document.getElementById('total').textContent}`, 14, finalY);
      doc.save('—Å–º–µ—Ç–∞_—Å–ø–∏—Å–∫–∏.pdf');
    }

    function exportToExcel() {
      const ws_data = [
        ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü–æ–∑–∏—Ü–∏—è', '–û–±—ä—ë–º (–º¬≥)', '–¶–µ–Ω–∞ –∑–∞ 1 –º¬≥ (—Ä—É–±.)', '–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º.', '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)']
      ];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = parseFloat(row.cells[2].querySelector('input')?.value) || '';
        const price = parseFloat(row.cells[3].querySelector('input')?.value) || '';
        const value = parseFloat(row.cells[5].textContent) || 0;
        ws_data.push([cat, desc, qty, price, '–º¬≥', value]);
      });
      ws_data.push(['', '', '', '', '–ò–¢–û–ì–û:', document.getElementById('total').textContent]);
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, '–°–º–µ—Ç–∞ (–º¬≥)');
      XLSX.writeFile(wb, '—Å–º–µ—Ç–∞_—Å–ø–∏—Å–∫–∏.xlsx');
    }
  </script>
</body>
</html>
