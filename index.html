<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { padding: 20px; background: #f9f9f9; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f1f1f1; }
    select, input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="number"] { text-align: right; }
    .readonly-cell {
      background-color: #f0f0f0;
      cursor: not-allowed;
      pointer-events: none;
      user-select: none;
    }
    .value-cell {
      background-color: #f9f9f9;
      font-weight: bold;
      pointer-events: none;
      user-select: text;
    }
    .actions button {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      background: #e74c3c;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .actions button:hover { background: #c0392b; }
    .btn-group {
      text-align: center;
      margin: 20px 0;
    }
    .btn-group button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 5px;
      background: #3498db;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-group button:hover { background: #2980b9; }
    .total-row {
      font-weight: bold;
      background: #f8f9fa;
    }
    .footer {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</h1>
    <h2>–° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è</h2>

    <table id="costTable">
      <thead>
        <tr>
          <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          <th>–ü–æ–∑–∏—Ü–∏—è</th>
          <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
          <th>–¶–µ–Ω–∞ –∑–∞ –µ–¥. (—Ä—É–±.)</th>
          <th>–ï–¥. –∏–∑–º.</th>
          <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
      <tfoot>
        <tr class="total-row">
          <td colspan="5" style="text-align: right;">–ò–¢–û–ì–û:</td>
          <td id="total">0.00 —Ä—É–±.</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="btn-group">
      <button onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
      <button onclick="exportToPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
      <button onclick="exportToExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX</button>
    </div>

    <div class="footer">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø–æ–∑–∏—Ü–∏—é ‚Äî –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
      <p><strong>–¶–µ–Ω—É –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ —Å–∞–º–∏</strong>. –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    </div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    // –î–∞–Ω–Ω—ã–µ: —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí –ø–æ–∑–∏—Ü–∏–∏ ‚Üí –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
    const items = {
      "–§—É–Ω–¥–∞–º–µ–Ω—Ç": [
        { name: "–ë–µ—Ç–æ–Ω", unit: "–º¬≥" },
        { name: "–ê—Ä–º–∞—Ç—É—Ä–∞", unit: "—Ç" }
      ],
      "–°—Ç–µ–Ω—ã": [
        { name: "–ì–∞–∑–æ–±–µ—Ç–æ–Ω", unit: "–º¬≥" },
        { name: "–ö–∏—Ä–ø–∏—á", unit: "—à—Ç." }
      ],
      "–ö—Ä—ã—à–∞": [
        { name: "–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞", unit: "–º¬≤" },
        { name: "–°—Ç—Ä–æ–ø–∏–ª–∞", unit: "–º.–ø." }
      ],
      "–ü–æ–ª—ã": [
        { name: "–°—Ç—è–∂–∫–∞", unit: "–º¬≥" },
        { name: "–õ–∞–º–∏–Ω–∞—Ç", unit: "–º¬≤" }
      ]
    };

    const categories = Object.keys(items);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('kalkulatorData');
      if (saved) {
        JSON.parse(saved).forEach(item => addRow(item));
      } else {
        addRow(); // –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }
      recalc();
    });

    function createCategorySelect(selected = '') {
      let html = '<select><option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>';
      categories.forEach(cat => {
        html += `<option value="${cat}" ${cat === selected ? 'selected' : ''}>${cat}</option>`;
      });
      html += '</select>';
      return html;
    }

    function createPositionSelect(category, selectedName = '') {
      if (!category || !items[category]) {
        return '<select disabled><option>‚Äî –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî</option></select>';
      }
      let html = '<select><option value="">‚Äî –ü–æ–∑–∏—Ü–∏—è ‚Äî</option>';
      items[category].forEach(item => {
        html += `<option value="${item.name}" data-unit="${item.unit}" ${item.name === selectedName ? 'selected' : ''}>${item.name}</option>`;
      });
      html += '</select>';
      return html;
    }

    function addRow(data = null) {
      const tbody = document.getElementById('tableBody');
      const row = tbody.insertRow();

      const category = data?.category || '';
      const description = data?.description || '';
      const qty = data?.qty || '';
      const price = data?.price || '';

      let unit = '';
      if (category && description) {
        const item = items[category]?.find(i => i.name === description);
        unit = item ? item.unit : '';
      }

      row.innerHTML = `
        <td>${createCategorySelect(category)}</td>
        <td>${createPositionSelect(category, description)}</td>
        <td><input type="number" min="0" step="0.01" value="${qty}" oninput="recalc()"></td>
        <td><input type="number" min="0" step="0.01" value="${price}" oninput="recalc()"></td>
        <td class="readonly-cell">${unit}</td>
        <td class="value-cell">0.00</td>
        <td class="actions"><button onclick="removeRow(this)">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;

      const catSelect = row.cells[0].querySelector('select');
      const posSelect = row.cells[1].querySelector('select');

      catSelect.onchange = () => {
        const newCat = catSelect.value;
        row.cells[1].innerHTML = createPositionSelect(newCat);
        const newSelect = row.cells[1].querySelector('select');
        if (newSelect) {
          newSelect.onchange = () => {
            const unitVal = newSelect.selectedOptions[0]?.dataset.unit || '';
            row.cells[4].textContent = unitVal;
            recalc();
            saveData();
          };
        }
        row.cells[4].textContent = '';
        recalc();
        saveData();
      };

      if (posSelect && !posSelect.disabled) {
        posSelect.onchange = () => {
          const unitVal = posSelect.selectedOptions[0]?.dataset.unit || '';
          row.cells[4].textContent = unitVal;
          recalc();
          saveData();
        };
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
        if (unit) {
          row.cells[4].textContent = unit;
        }
      }

      recalc();
      saveData();
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      recalc();
      saveData();
    }

    function recalc() {
      let total = 0;
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const qty = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const price = parseFloat(row.cells[3].querySelector('input').value) || 0;
        const value = qty * price;
        row.cells[5].textContent = value.toFixed(2);
        total += value;
      });
      document.getElementById('total').textContent = total.toFixed(2) + ' —Ä—É–±.';
    }

    function saveData() {
      const rows = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = row.cells[2].querySelector('input')?.value || '';
        const price = row.cells[3].querySelector('input')?.value || '';
        rows.push({ category: cat, description: desc, qty, price });
      });
      localStorage.setItem('kalkulatorData', JSON.stringify(rows));
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
    function exportToPDF() {
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞', 14, 20);
      const tableData = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = parseFloat(row.cells[2].querySelector('input')?.value) || '';
        const price = parseFloat(row.cells[3].querySelector('input')?.value) || '';
        const unit = row.cells[4].textContent;
        const value = parseFloat(row.cells[5].textContent) || 0;
        tableData.push([cat, desc, qty, price, unit, value]);
      });
      doc.autoTable({
        startY: 30,
        head: [['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü–æ–∑–∏—Ü–∏—è', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–¶–µ–Ω–∞ –∑–∞ –µ–¥.', '–ï–¥. –∏–∑–º.', '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219] }
      });
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(14);
      doc.text(`–ò—Ç–æ–≥–æ: ${document.getElementById('total').textContent}`, 14, finalY);
      doc.save('—Å–º–µ—Ç–∞.pdf');
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
    function exportToExcel() {
      const ws_data = [
        ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü–æ–∑–∏—Ü–∏—è', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—Ä—É–±.)', '–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è', '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)']
      ];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = parseFloat(row.cells[2].querySelector('input')?.value) || '';
        const price = parseFloat(row.cells[3].querySelector('input')?.value) || '';
        const unit = row.cells[4].textContent;
        const value = parseFloat(row.cells[5].textContent) || 0;
        ws_data.push([cat, desc, qty, price, unit, value]);
      });
      ws_data.push(['', '', '', '', '–ò–¢–û–ì–û:', document.getElementById('total').textContent]);
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, '–°–º–µ—Ç–∞');
      XLSX.writeFile(wb, '—Å–º–µ—Ç–∞.xlsx');
    }
  </script>
</body>
</html>
