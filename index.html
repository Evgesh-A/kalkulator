<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { padding: 20px; background: #f9f9f9; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f1f1f1; }
    select, input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="number"] { text-align: right; }
    .readonly-cell {
      background-color: #f0f0f0;
      cursor: not-allowed;
      pointer-events: none;
      user-select: none;
    }
    .value-cell {
      background-color: #f9f9f9;
      font-weight: bold;
      pointer-events: none;
      user-select: text;
    }
    .actions button {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      background: #e74c3c;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .actions button:hover { background: #c0392b; }
    .btn-group {
      text-align: center;
      margin: 20px 0;
    }
    .btn-group button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 5px;
      background: #3498db;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-group button:hover { background: #2980b9; }
    .total-row {
      font-weight: bold;
      background: #f8f9fa;
    }
    .footer {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
    #pdfTable { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</h1>
    <h2>–° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è</h2>

    <table id="costTable">
      <thead>
        <tr>
          <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          <th>–ü–æ–∑–∏—Ü–∏—è</th>
          <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
          <th>–¶–µ–Ω–∞ –∑–∞ –µ–¥. (—Ä—É–±.)</th>
          <th>–ï–¥. –∏–∑–º.</th>
          <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
      <tfoot>
        <tr class="total-row">
          <td colspan="5" style="text-align: right;">–ò–¢–û–ì–û:</td>
          <td id="total">0.00 —Ä—É–±.</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="btn-group">
      <button onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
      <button onclick="exportToPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
      <button onclick="exportToExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX</button>
    </div>

    <div class="footer">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Üí –ø–æ–∑–∏—Ü–∏—é. –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
      <p><strong>–¶–µ–Ω—É —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –≤—ã —Å–∞–º–∏.</strong> –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    </div>
  </div>

  <!-- –°–∫—Ä—ã—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è PDF -->
  <div id="pdfTable" style="font-family: Arial; padding: 20px; width: 800px;">
    <h2 style="text-align: center;">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</h2>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
      <thead>
        <tr>
          <th style="border: 1px solid #000; padding: 8px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          <th style="border: 1px solid #000; padding: 8px;">–ü–æ–∑–∏—Ü–∏—è</th>
          <th style="border: 1px solid #000; padding: 8px;">–ö–æ–ª-–≤–æ</th>
          <th style="border: 1px solid #000; padding: 8px;">–¶–µ–Ω–∞</th>
          <th style="border: 1px solid #000; padding: 8px;">–ï–¥. –∏–∑–º.</th>
          <th style="border: 1px solid #000; padding: 8px;">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
        </tr>
      </thead>
      <tbody id="pdfTableBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="5" style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">–ò–¢–û–ì–û:</td>
          <td id="pdfTotal" style="border: 1px solid #000; padding: 8px; font-weight: bold;"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    const items = {
      "–§—É–Ω–¥–∞–º–µ–Ω—Ç": [{ name: "–ë–µ—Ç–æ–Ω", unit: "–º¬≥" }, { name: "–ê—Ä–º–∞—Ç—É—Ä–∞", unit: "—Ç" }],
      "–°—Ç–µ–Ω—ã": [{ name: "–ì–∞–∑–æ–±–µ—Ç–æ–Ω", unit: "–º¬≥" }, { name: "–ö–∏—Ä–ø–∏—á", unit: "—à—Ç." }],
      "–ö—Ä—ã—à–∞": [{ name: "–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞", unit: "–º¬≤" }, { name: "–°—Ç—Ä–æ–ø–∏–ª–∞", unit: "–º.–ø." }],
      "–ü–æ–ª—ã": [{ name: "–°—Ç—è–∂–∫–∞", unit: "–º¬≥" }, { name: "–õ–∞–º–∏–Ω–∞—Ç", unit: "–º¬≤" }]
    };
    const categories = Object.keys(items);

    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('kalkulatorData');
      if (saved) {
        JSON.parse(saved).forEach(item => addRow(item));
      } else {
        addRow();
      }
      recalc();
    });

    function createCategorySelect(selected = '') {
      let html = '<select><option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>';
      categories.forEach(cat => {
        html += `<option value="${cat}" ${cat === selected ? 'selected' : ''}>${cat}</option>`;
      });
      html += '</select>';
      return html;
    }

    function createPositionSelect(category, selectedName = '') {
      if (!category || !items[category]) {
        return '<select><option value="">‚Äî –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî</option></select>';
      }
      let html = '<select><option value="">‚Äî –ü–æ–∑–∏—Ü–∏—è ‚Äî</option>';
      items[category].forEach(item => {
        html += `<option value="${item.name}" data-unit="${item.unit}" ${item.name === selectedName ? 'selected' : ''}>${item.name}</option>`;
      });
      html += '</select>';
      return html;
    }

    function addRow(data = null) {
      const tbody = document.getElementById('tableBody');
      const row = tbody.insertRow();
      const category = data?.category || '';
      const description = data?.description || '';
      const qty = data?.qty || '';
      const price = data?.price || '';
      let unit = '';
      if (category && description) {
        const item = items[category]?.find(i => i.name === description);
        unit = item ? item.unit : '';
      }

      row.innerHTML = `
        <td>${createCategorySelect(category)}</td>
        <td>${createPositionSelect(category, description)}</td>
        <td><input type="number" min="0" step="0.01" value="${qty}" oninput="recalc()"></td>
        <td><input type="number" min="0" step="0.01" value="${price}" oninput="recalc()"></td>
        <td class="readonly-cell">${unit}</td>
        <td class="value-cell">0.00</td>
        <td class="actions"><button onclick="removeRow(this)">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;

      const catSelect = row.cells[0].querySelector('select');
      const posSelect = row.cells[1].querySelector('select');

      catSelect.onchange = () => {
        const newCat = catSelect.value;
        row.cells[1].innerHTML = createPositionSelect(newCat);
        const newPosSelect = row.cells[1].querySelector('select');
        newPosSelect.onchange = () => {
          const unitVal = newPosSelect.selectedOptions[0]?.dataset.unit || '';
          row.cells[4].textContent = unitVal;
          recalc();
          saveData();
        };
        row.cells[4].textContent = '';
        recalc();
        saveData();
      };

      posSelect.onchange = () => {
        const unitVal = posSelect.selectedOptions[0]?.dataset.unit || '';
        row.cells[4].textContent = unitVal;
        recalc();
        saveData();
      };

      recalc();
      saveData();
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      recalc();
      saveData();
    }

    function recalc() {
      let total = 0;
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const qty = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const price = parseFloat(row.cells[3].querySelector('input').value) || 0;
        const value = qty * price;
        row.cells[5].textContent = value.toFixed(2);
        total += value;
      });
      document.getElementById('total').textContent = total.toFixed(2) + ' —Ä—É–±.';
    }

    function saveData() {
      const rows = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = row.cells[2].querySelector('input')?.value || '';
        const price = row.cells[3].querySelector('input')?.value || '';
        rows.push({ category: cat, description: desc, qty, price });
      });
      localStorage.setItem('kalkulatorData', JSON.stringify(rows));
    }

    // ‚úÖ –≠–ö–°–ü–û–†–¢ –í PDF –ß–ï–†–ï–ó html2canvas (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!)
    async function exportToPDF() {
  try {
    const pdfTable = document.getElementById('pdfTable');
    const originalDisplay = pdfTable.style.display;

    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
    pdfTable.style.display = 'block';
    pdfTable.style.visibility = 'hidden'; // —á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ
    pdfTable.style.position = 'absolute';
    pdfTable.style.left = '-10000px'; // —É–±–∏—Ä–∞–µ–º –∑–∞ —ç–∫—Ä–∞–Ω

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    const pdfBody = document.getElementById('pdfTableBody');
    pdfBody.innerHTML = '';
    document.querySelectorAll('#tableBody tr').forEach(row => {
      const cat = row.cells[0].querySelector('select')?.value || '';
      const desc = row.cells[1].querySelector('select')?.value || '';
      const qty = row.cells[2].querySelector('input')?.value || '';
      const price = row.cells[3].querySelector('input')?.value || '';
      const unit = row.cells[4].textContent;
      const value = row.cells[5].textContent;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="border:1px solid #000;padding:6px;">${cat}</td>
        <td style="border:1px solid #000;padding:6px;">${desc}</td>
        <td style="border:1px solid #000;padding:6px;">${qty}</td>
        <td style="border:1px solid #000;padding:6px;">${price}</td>
        <td style="border:1px solid #000;padding:6px;">${unit}</td>
        <td style="border:1px solid #000;padding:6px;">${value}</td>
      `;
      pdfBody.appendChild(tr);
    });
    document.getElementById('pdfTotal').textContent = document.getElementById('total').textContent;

    // –î–µ–ª–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
    const canvas = await html2canvas(pdfTable, {
      scale: 1.5,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    });

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ
    pdfTable.style.display = originalDisplay;

    // –°–æ–∑–¥–∞—ë–º PDF
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210; // A4 width
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    if (imgHeight > 0) {
      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      pdf.save('—Å–º–µ—Ç–∞.pdf');
    } else {
      throw new Error('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤—É—é –≤—ã—Å–æ—Ç—É');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ PDF:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).');
  }
}
    function exportToExcel() {
      const ws_data = [
        ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü–æ–∑–∏—Ü–∏—è', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—Ä—É–±.)', '–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è', '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)']
      ];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cat = row.cells[0].querySelector('select')?.value || '';
        const desc = row.cells[1].querySelector('select')?.value || '';
        const qty = parseFloat(row.cells[2].querySelector('input')?.value) || '';
        const price = parseFloat(row.cells[3].querySelector('input')?.value) || '';
        const unit = row.cells[4].textContent;
        const value = parseFloat(row.cells[5].textContent) || 0;
        ws_data.push([cat, desc, qty, price, unit, value]);
      });
      ws_data.push(['', '', '', '', '–ò–¢–û–ì–û:', document.getElementById('total').textContent]);
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, '–°–º–µ—Ç–∞');
      XLSX.writeFile(wb, '—Å–º–µ—Ç–∞.xlsx');
    }
  </script>
</body>
</html>
